<?
// Fonction pour transfortmer des dates en FR
$date = "2001-09-03";
$prefix = "Le ";
$suffix = " à";
$tab_month = array(1=>"Janvier", "Fevrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Aout", "Septembre", "Octobre", "Novembre", "Decembre");
$tab_day = array("Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi");
$tab_date = explode(' ', $date);
$date_hour = explode(':', $tab_date[1]);
$tab_dmy = explode('-', $tab_date[0]);
$day = date("w", mktime(0, 0, 0, $tab_dmy[1], $tab_dmy[2], $tab_dmy[0]));
$date = $prefix . "$tab_day[$day] " . "$tab_dmy[2] ";
settype($tab_dmy[1], integer);
$date .= $tab_month[$tab_dmy[1]] . " $tab_dmy[0]" . $suffix . " $date_hour[0]h " . "$date_hour[1]min";

echo $date;

// Fonction d'échappement des quotes pour éviter les injections SQL
function secure_mysql($string) {
 	//$string=addslashes($string);
 	$string=str_replace("'","\'",$string);
 	$string=str_replace('"','\"',$string);
 	return $string;
}

// récupération des données
function recuperation_donnees ($sql) {
	$result=mysql_query($sql)
		or die($sql.'<br/><strong>'.mysql_error().'</strong>');
	$return_array=array();
	$i=0;
	while ($data=mysql_fetch_array($result,MYSQL_ASSOC)) {
		foreach ($data as $champ => $valeur) {
			$return_array[$i][$champ]=$valeur;	
		}		
		$i++;
	}
	mysql_free_result($result);
	
	return $return_array;
}

// création d'un tableau filtrant
function creation_table($sql,$champs,$post_sql,$mode) {
	global $params;
	$section=$_POST['section'];
	  	
	// Application des filtres 
	if (isset($_POST['filtres'])) {
		$filtres=$_POST['filtres'];
		if ($_POST['conserver_filtres']=='oui')	{
			$_SESSION['filtres'.$section]=$_POST['filtres'];
		}
	} elseif (isset($_SESSION['filtres'.$section])){
		$filtres=$_SESSION['filtres'.$section];
	} 
	if (isset($filtres)) {
		$sql.=" WHERE ";
		$i_champ=0;
		foreach	($filtres as $champ => $value) {
			if (!empty($value)) {
				if ($i_champ==0 and is_int($value)) {
					$sql.=$champ."=".secure_mysql($value)." AND ";
				} else {
					$sql.=$champ." LIKE '%".secure_mysql($value)."%' AND ";
				} 
			}
			$i_champ++;
		}
		$sql.="1=1";
	}
	
	
	$sql.=$post_sql;
	
	if (isset($_POST['limite']) AND is_numeric($_POST['limite'])) {
		$sql.=" LIMIT ".round($_POST['limite']);
		$limite=round($_POST['limite']);
	}
	$tableau=recuperation_donnees($sql);
	
	// Création du formulaire de filtrage
	$html.='<form id="form_filtrage"  method="POST">
			<input type="hidden" name="page" value="'.$_POST['page'].'"/>
			<input type="hidden" name="section" value="'.$_POST['section'].'"/>
			<input type="hidden" name="filtrage_soumis" value="oui"/>'.
		$input_table.'
		<table class="table_sel" id="table_liste" cellpadding="0" cellspacing="0" style="display:block;" width="'.$_POST['table_width'].'">
		<thead id="liste_header">
			<tr>';
	$html.='<td colspan="3" class="liste_container_bt">
					<input type="button" value="AJOUTER UNE ENTRÉE" 
						onclick="affElement(\''.$_POST['page'].'\',\''.$_POST['section'].'\',\'\',\'ajouter\',\'content\');"> 
				</td>
				<td>';
	$html.='<span id="n_record">'.sizeof($tableau).' entrées</span> <input type="checkbox" name="conserver_filtres" value="oui" checked="checked"> Conserver les filtres</td>';
	
	
	
	
	$colspan='2';
	$html.='</td>
		</tr>
		<tr>
			<th colspan="'.$colspan.'"> Afficher 
				<input name="limite" onkeyup="lancetimer();" type="text" value="'.$limite.'" size="3"></th>';
	foreach($champs as $k_champ =>$champ) {
		$html.='<th>'.$champ[0].'</th>';
	}

	$html.='</tr><tr><th colspan="'.$colspan.'">Filtrer</th>';
	// Affichage des entêtes de champs
	foreach($champs as $k_champ =>$champ) {
		$html.='<th>
			<input style="width:100%;" onkeyup="lancetimer();" onsubmit="lancetimer();" type="text" 
				name="filtres['.$champ[1].']." value="'.$filtres[$champ[1]].'">
			</th>';
	}
	$html.='</tr></thead><tbody id="table_body">';
	
	// Affichage des lignes 
  	if (empty($tableau)) {
  		$html.='<tr><td colspan="'.(sizeof($champs)+$colspan).'">Aucune données dans la base.</td></tr>';
  	} else {
  		foreach ($tableau as $ligne) {
  			$html.='<tr>';
  			$i_champ=0;
  			foreach($champs as $k_champ => $champ) {
  				if($i_champ<1)  {			
  					$html.='<td class="td_selection">
		 						<img src="public/images/icons/modifier.png"
		  						onclick="affElement(\''.$_POST['page'].'\',\''.$_POST['section'].'\',\''.$ligne[$k_champ].'\',\'modifier\',\'content\')"/>
		  					</td><td class="td_selection">
		  						<img src="public/images/icons/supprimer.png"
		  						onclick="affElement(\''.$_POST['page'].'\',\''.$_POST['section'].'\',\''.$ligne[$k_champ].'\',\'supprimer\',\'content\')"/>
		  					</td>';
  				} else {
					$html.='<td>'.$ligne[$k_champ].'</td>';
  				}
				$i_champ++;
  			}	
  			$html.='</tr>';	
  		}
  	}
		
	$html.='</tbody></table></form>';  
	return $html;
}

function lire_rss($url,$nbr=5)
{
  $tout.='<ul>';
  $xml = simplexml_load_file($url) ;
  foreach($xml->channel->item as $item) {
    $i++;
    if($i<=$nbr){
    $txt=utf8_decode($item->description); $lien=utf8_decode($item->link); $titre=utf8_decode($item->title);
      $tout.='
      <li>
        <a href='.htmlentities($lien).'><b>'.htmlentities($titre).'</b></a> <br />
      </li>
      ';
    }
  }
  $tout.='</ul>';
  
  return $tout;
}

